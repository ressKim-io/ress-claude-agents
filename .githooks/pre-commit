#!/usr/bin/env bash
# pre-commit hook - Documentation consistency and shell script validation
# Install: ./scripts/setup-hooks.sh

set -euo pipefail

readonly SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
readonly PROJECT_ROOT="$(cd "${SCRIPT_DIR}/.." && pwd)"

# Colors for output
readonly RED='\033[0;31m'
readonly GREEN='\033[0;32m'
readonly YELLOW='\033[0;33m'
readonly NC='\033[0m' # No Color

log_info() {
    echo -e "[pre-commit] $1"
}

log_success() {
    echo -e "${GREEN}[pre-commit]${NC} $1"
}

log_warning() {
    echo -e "${YELLOW}[pre-commit]${NC} $1"
}

log_error() {
    echo -e "${RED}[pre-commit]${NC} $1"
}

# -----------------------------------------------------------------------------
# Documentation Consistency Validation
# -----------------------------------------------------------------------------

validate_docs() {
    log_info "Validating documentation consistency..."

    local generate_docs="${PROJECT_ROOT}/scripts/generate-docs.sh"

    if [[ ! -x "${generate_docs}" ]]; then
        log_error "generate-docs.sh not found or not executable"
        return 1
    fi

    if ! "${generate_docs}" validate; then
        log_error "Documentation validation failed"
        log_info "Run './scripts/generate-docs.sh' to see details and fix issues"
        return 1
    fi

    log_success "Documentation validation passed"
    return 0
}

# -----------------------------------------------------------------------------
# ShellCheck Validation (Optional)
# -----------------------------------------------------------------------------

run_shellcheck() {
    # Skip if shellcheck is not installed
    if ! command -v shellcheck &>/dev/null; then
        log_warning "shellcheck not installed, skipping shell script validation"
        log_info "Install with: brew install shellcheck"
        return 0
    fi

    log_info "Running shellcheck on staged shell scripts..."

    # Get staged shell scripts
    local staged_scripts
    staged_scripts=$(git diff --cached --name-only --diff-filter=ACM | grep -E '\.(sh|bash)$' || true)

    if [[ -z "${staged_scripts}" ]]; then
        log_info "No shell scripts staged, skipping shellcheck"
        return 0
    fi

    local errors=0

    while IFS= read -r script; do
        if [[ -f "${PROJECT_ROOT}/${script}" ]]; then
            if ! shellcheck -x "${PROJECT_ROOT}/${script}"; then
                ((errors++))
            fi
        fi
    done <<< "${staged_scripts}"

    if [[ ${errors} -gt 0 ]]; then
        log_error "shellcheck found issues in ${errors} file(s)"
        return 1
    fi

    log_success "shellcheck passed"
    return 0
}

# -----------------------------------------------------------------------------
# Main
# -----------------------------------------------------------------------------

main() {
    echo ""
    log_info "Running pre-commit checks..."
    echo ""

    local exit_code=0

    # 1. Documentation consistency validation (required)
    if ! validate_docs; then
        exit_code=1
    fi

    echo ""

    # 2. ShellCheck (optional, only if installed)
    if ! run_shellcheck; then
        exit_code=1
    fi

    echo ""

    if [[ ${exit_code} -ne 0 ]]; then
        log_error "Pre-commit checks failed. Commit aborted."
        log_info "Fix the issues above and try again."
        exit 1
    fi

    log_success "All pre-commit checks passed!"
    echo ""
}

main "$@"
